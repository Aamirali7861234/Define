<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multi OTP Tool</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    .box {
      background: #fff;
      padding: 15px;
      margin: 15px auto;
      border-radius: 10px;
      max-width: 600px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
    }
    label, select, input, button {
      display: block;
      width: 100%;
      margin-top: 10px;
    }
    input, select {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #28a745;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
      cursor: pointer;
    }
    button:hover {
      background: #218838;
    }
    #loading {
      display: none;
      text-align: center;
      margin: 10px 0;
    }
    .spinner {
      border: 4px solid #ccc;
      border-top: 4px solid #28a745;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      margin: auto;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .history {
      background: #eee;
      padding: 10px;
      white-space: pre-wrap;
      font-size: 14px;
      border-radius: 6px;
    }
    .cancel-btn {
      background: red;
      color: white;
      padding: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .cancel-btn:hover {
      background: darkred;
    }
    .number-clickable {
      cursor: pointer;
      color: blue;
    }
  </style>
</head>
<body>
  <h2>OTP Multi Number Tool</h2>

  <div class="box">
    <strong>Balance:</strong> <span id="balance">Loading...</span>
  </div>

  <div class="box">
    <input type="text" id="search" placeholder="Search service..." oninput="filterServices()">
    <select id="services"><option>Loading...</option></select>

    <label>How many numbers?</label>
    <input type="number" id="count" value="1" min="1" max="10" />

    <button onclick="getNumbers()">Get Numbers</button>
    <div id="loading"><div class="spinner"></div></div>
  </div>

  <div class="box history" id="history">History will appear here...</div>

  <script>
    const access = "4228a01beefaac1bb7f1fc3b7412a422";
    const proxy = "https://api.codetabs.com/v1/proxy?quest=";
    const historyLog = [];
    const activeNumbers = {};

    const fetchProxy = async (url) => {
      const res = await fetch(proxy + encodeURIComponent(url));
      return await res.text();
    };

    const updateHistoryBox = () => {
      const waiting = [];
      const completed = [];
      Object.values(activeNumbers).forEach(entry => {
        if (entry.otp) {
          completed.push(`${entry.display} => OTP: ${entry.otp}`);
        } else {
          waiting.push(`${entry.display} [Waiting OTP] ${entry.cancelBtn}`);
        }
      });
      document.getElementById("history").innerHTML = [...waiting, ...completed].join('<br>');
    };

    const cancelNumber = async (id, num) => {
      try {
        const res = await fetchProxy(`https://readyacc.store/api/api.php?access=${access}&type=cancel&id=${id}`);
        
        // Check if the response indicates successful cancellation
        if (res.includes("CANCELLED")) {
          // Show the number as cancelled after a slight delay
          setTimeout(() => {
            activeNumbers[id].display += ` (Cancelled)`;
            updateHistoryBox();
          }, 2000); // Delay before showing cancelled status
        } else {
          alert(`Failed to cancel number: ${num}`);
        }
      } catch (err) {
        alert(`Error cancelling number: ${err.message}`);
      }
    };

    const createNumberEntry = (i, id, num) => {
      const stripped = num.replace(/^91/, "");
      const display = `<span class="number-clickable" onclick="navigator.clipboard.writeText('${stripped}')">${stripped}</span>`;
      const cancelBtn = `<button class="cancel-btn" onclick="cancelNumber('${id}','${stripped}')">Cancel</button>`;
      activeNumbers[id] = { num, display: `Number ${i + 1}: ${display}`, cancelBtn, otp: null };
      updateHistoryBox();  // Update history after creating the entry
    };

    const getNumbers = async () => {
      const service = document.getElementById("services").value;
      const count = parseInt(document.getElementById("count").value) || 1;
      const loading = document.getElementById("loading");
      loading.style.display = "block";

      for (let i = 0; i < count; i++) {
        try {
          const res = await fetchProxy(`https://readyacc.store/api/api.php?access=${access}&type=getNewNumber&service=${service}`);
          if (!res.startsWith("ACCESS_NUMBER")) {
            updateHistoryBox(`FAILED to get number (${i+1}): ${res}`);
            continue;
          }
          const [, id, num] = res.split(":");
          createNumberEntry(i, id, num);
          updateHistoryBox();

          let tries = 0;
          const poll = setInterval(async () => {
            tries++;
            const status = await fetchProxy(`https://readyacc.store/api/api.php?access=${access}&type=getNmSt&id=${id}`);
            if (status.startsWith("STATUS_OK:")) {
              clearInterval(poll);
              const otp = status.split(":")[1];
              activeNumbers[id].otp = otp;
              updateHistoryBox();
            } else if (tries > 12) {
              clearInterval(poll);
              activeNumbers[id].display += " => OTP Timeout";
              updateHistoryBox();
              setTimeout(() => cancelNumber(id, num), 2000); // Auto-remove on timeout
            }
          }, 5000);

        } catch (err) {
          updateHistoryBox(`Error getting number (${i+1}): ${err.message}`);
        }
      }

      loading.style.display = "none";
    };

    const loadBalance = async () => {
      try {
        const res = await fetchProxy(`https://readyacc.store/api/api.php?access=${access}&type=getAvailableBalance`);
        const bal = res.split(":")[1] || "0";
        document.getElementById("balance").textContent = bal;
      } catch {
        document.getElementById("balance").textContent = "Error";
      }
    };

    const loadServices = async () => {
      try {
        const res = await fetchProxy(`https://readyacc.store/api/api.php?access=${access}&type=getServiceList`);
        const data = JSON.parse(res);
        const sel = document.getElementById("services");
        sel.innerHTML = "";
        Object.entries(data).forEach(([code, name]) => {
          const opt = document.createElement("option");
          opt.value = code;
          opt.textContent = `${name} (${code})`;
          sel.appendChild(opt);
        });
      } catch {
        document.getElementById("services").innerHTML = "<option>Error</option>";
      }
    };

    const filterServices = () => {
      const query = document.getElementById("search").value.toLowerCase();
      const options = document.querySelectorAll("#services option");
      options.forEach(opt => {
        const visible = opt.textContent.toLowerCase().includes(query);
        opt.style.display = visible ? "" : "none";
        if (visible) opt.selected = true;
      });
    };

    window.onload = () => {
      loadBalance();
      loadServices();
    };
  </script>
</body>
</html>
